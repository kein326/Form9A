<!doctype html>
<html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>CGAF 9(a) – Quick PDF Filler (Use your filled PDF)</title>
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:900px;margin:24px auto;padding:0 16px}
.card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:12px 0}
label{display:block;font-weight:600;margin:10px 0 4px}
input,select,button{font-size:16px;padding:10px;border:1px solid #cbd5e1;border-radius:8px;width:100%}
.grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.btn{background:#111827;color:#fff;border:none;cursor:pointer}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
</style>
</head>
<body>
<h1>CGAF 9(a) – Quick PDF Filler</h1>
<div class="card">
  <p>手順：<b>「記入済みPDF」</b>を選択 → 最新の入国日と延長月数を選び、<b>Generate</b> を押すだけ。</p>
</div>
<div class="card">
  <div class="grid">
    <div>
      <label>記入済みPDF（form.pdfなど）</label>
      <input id="file" type="file" accept="application/pdf" required>
    </div>
    <div>
      <label>Date of Latest Arrival</label>
      <input id="arrival" type="date" required>
    </div>
    <div>
      <label>Months to Extend</label>
      <select id="months">
        <option value="1" selected>One (1) month</option>
        <option value="2">Two (2) months</option>
        <option value="6">Six (6) months</option>
      </select>
    </div>
    <div>
      <label>Flight/Voyage No.（任意）</label>
      <input id="flight" type="text" placeholder="空欄でもOK">
    </div>
  </div>
  <div style="margin-top:12px" class="grid">
    <div>
      <label>Nudge X（pt, 微調整 任意）</label>
      <input id="dx" type="number" value="0" step="0.5">
    </div>
    <div>
      <label>Nudge Y（pt, 微調整 任意）</label>
      <input id="dy" type="number" value="0" step="0.5">
    </div>
  </div>
  <div style="margin-top:12px">
    <button class="btn" id="gen">Generate PDF</button>
  </div>
</div>
<div class="card" id="done" style="display:none">
  完了：<span class="mono" id="fname"></span> をダウンロードしました。
</div>

<script>
function drawText(page, text, x, y, dx, dy, font, size=10){
  page.drawText(text, { x:x+dx, y:y+dy, size, font });
}
function drawCheck(page, x, y, dx, dy, font){
  page.drawText("✔", { x:x+dx, y:y+dy, size:12, font });
}

document.getElementById('gen').addEventListener('click', async () => {
  const f = document.getElementById('file').files[0];
  if(!f){ alert('まず「記入済みPDF」を選択してください。'); return; }
  const arrival = document.getElementById('arrival').value;
  if(!arrival){ alert("Date of Latest Arrival を選んでください。"); return; }
  const months = document.getElementById('months').value;
  const flight = document.getElementById('flight').value.trim();
  const dx = parseFloat(document.getElementById('dx').value || "0");
  const dy = parseFloat(document.getElementById('dy').value || "0");

  const d = new Date(arrival);
  const MMM = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"][d.getUTCMonth()];
  const DD  = String(d.getUTCDate()).padStart(2,"0");
  const YYYY= d.getUTCFullYear();
  const arrivalFmt = `${DD} ${MMM} ${YYYY}`;

  const buf = await f.arrayBuffer();
  const { PDFDocument, StandardFonts } = PDFLib;
  const pdf = await PDFDocument.load(buf);
  const font = await pdf.embedFont(StandardFonts.Helvetica);
  const page = pdf.getPage(0);

  // ★ 座標はあなたの記入済みPDF（form.pdf）基準のだいたいの位置。
  // 必要なら Nudge X/Y で微調整してください。
  // チェック欄（1ヶ月/2ヶ月/6ヶ月）
  if (months === "1") drawCheck(page, 130, 666, dx, dy, font);
  if (months === "2") drawCheck(page, 240, 666, dx, dy, font);
  if (months === "6") drawCheck(page, 345, 666, dx, dy, font);

  // 入国日・便名（TRAVEL INFORMATION）
  drawText(page, arrivalFmt, 180, 420, dx, dy, font);
  if (flight) drawText(page, flight, 460, 420, dx, dy, font);

  const out = await pdf.save();
  const blob = new Blob([out], { type: "application/pdf" });
  const name = `CGAF_${YYYY}-${String(d.getUTCMonth()+1).padStart(2,"0")}-${DD}_M${months}.pdf`;
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = name; a.click();
  URL.revokeObjectURL(url);
  document.getElementById('done').style.display = 'block';
  document.getElementById('fname').textContent = name;
});
</script>
</body></html>
